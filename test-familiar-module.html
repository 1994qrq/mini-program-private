<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ç†Ÿæ‚‰æ¨¡å—åŠŸèƒ½æµ‹è¯•</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Microsoft YaHei', 'Consolas', monospace;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
      line-height: 1.6;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: #252526;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    h1 {
      color: #4ec9b0;
      border-bottom: 3px solid #569cd6;
      padding-bottom: 15px;
      margin-bottom: 30px;
      font-size: 32px;
    }
    h2 {
      color: #dcdcaa;
      margin: 30px 0 15px 0;
      font-size: 24px;
      border-left: 4px solid #569cd6;
      padding-left: 15px;
    }
    h3 {
      color: #9cdcfe;
      margin: 20px 0 10px 0;
      font-size: 18px;
    }
    .test-suite {
      background: #1e1e1e;
      border: 1px solid #3c3c3c;
      border-radius: 6px;
      padding: 20px;
      margin: 15px 0;
    }
    .test-case {
      background: #2d2d30;
      border-left: 4px solid #007acc;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .test-case.pass {
      border-left-color: #4ec9b0;
      background: #1e3a1e;
    }
    .test-case.fail {
      border-left-color: #f48771;
      background: #3a1e1e;
    }
    .test-title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    .status.pass { background: #4ec9b0; color: #000; }
    .status.fail { background: #f48771; color: #000; }
    .status.running { background: #dcdcaa; color: #000; }
    .test-details {
      background: #1e1e1e;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-size: 14px;
      font-family: 'Consolas', monospace;
    }
    .code {
      background: #1e1e1e;
      border: 1px solid #3c3c3c;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-family: 'Consolas', monospace;
      font-size: 13px;
      overflow-x: auto;
      white-space: pre;
    }
    .summary {
      background: #264f78;
      color: white;
      padding: 25px;
      border-radius: 8px;
      margin: 30px 0;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .stat-card {
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 6px;
      text-align: center;
    }
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
    .log {
      color: #858585;
      font-size: 13px;
      margin: 5px 0;
    }
    .error {
      color: #f48771;
      font-weight: bold;
    }
    .success {
      color: #4ec9b0;
      font-weight: bold;
    }
    .warning {
      color: #dcdcaa;
    }
    button {
      background: #0e639c;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
      transition: background 0.2s;
    }
    button:hover {
      background: #1177bb;
    }
    button:active {
      background: #0d5a8f;
    }
    #output {
      background: #1e1e1e;
      border: 1px solid #3c3c3c;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
      max-height: 600px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª ç†Ÿæ‚‰æ¨¡å—åŠŸèƒ½æµ‹è¯•</h1>

    <div class="summary">
      <h2 style="color: white; border: none; margin-bottom: 15px;">æµ‹è¯•æ§åˆ¶é¢æ¿</h2>
      <button onclick="runAllTests()">â–¶ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
      <button onclick="runQuickTests()">âš¡ å¿«é€Ÿæµ‹è¯•</button>
      <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤ç»“æœ</button>
      <button onclick="exportResults()">ğŸ“„ å¯¼å‡ºæŠ¥å‘Š</button>
    </div>

    <div id="output"></div>

    <div id="results"></div>
  </div>

  <script>
    // ==================== æ¨¡æ‹Ÿ uni-app API ====================
    const mockStorage = {};
    window.uni = {
      getStorageSync: (key) => {
        const val = mockStorage[key];
        return val !== undefined ? JSON.parse(JSON.stringify(val)) : null;
      },
      setStorageSync: (key, value) => {
        mockStorage[key] = JSON.parse(JSON.stringify(value));
      },
      removeStorageSync: (key) => {
        delete mockStorage[key];
      }
    };

    // ==================== æµ‹è¯•è¾…åŠ©å‡½æ•° ====================
    let testResults = [];
    let currentSuite = '';

    function log(message, type = 'log') {
      const output = document.getElementById('output');
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'log';
      output.innerHTML += `<div class="${className}">${message}</div>`;
      output.scrollTop = output.scrollHeight;
    }

    function assert(condition, message) {
      if (!condition) {
        throw new Error(`æ–­è¨€å¤±è´¥: ${message}`);
      }
    }

    function assertEqual(actual, expected, message) {
      if (actual !== expected) {
        throw new Error(`${message}\næœŸæœ›: ${expected}\nå®é™…: ${actual}`);
      }
    }

    function assertGreaterThan(actual, expected, message) {
      if (actual <= expected) {
        throw new Error(`${message}\næœŸæœ›å¤§äº: ${expected}\nå®é™…: ${actual}`);
      }
    }

    function testCase(name, fn) {
      const startTime = Date.now();
      try {
        fn();
        const duration = Date.now() - startTime;
        testResults.push({ suite: currentSuite, name, status: 'pass', duration, error: null });
        log(`âœ“ ${name} (${duration}ms)`, 'success');
        return true;
      } catch (error) {
        const duration = Date.now() - startTime;
        testResults.push({ suite: currentSuite, name, status: 'fail', duration, error: error.message });
        log(`âœ— ${name} - ${error.message} (${duration}ms)`, 'error');
        return false;
      }
    }

    function testSuite(name, fn) {
      currentSuite = name;
      log(`\n======== ${name} ========`, 'warning');
      fn();
    }

    function clearResults() {
      document.getElementById('output').innerHTML = '';
      document.getElementById('results').innerHTML = '';
      testResults = [];
      mockStorage.clear = () => {
        for (let key in mockStorage) {
          delete mockStorage[key];
        }
      };
      mockStorage.clear();
      log('æµ‹è¯•ç¯å¢ƒå·²é‡ç½®', 'success');
    }

    function renderResults() {
      const resultsDiv = document.getElementById('results');
      const passed = testResults.filter(t => t.status === 'pass').length;
      const failed = testResults.filter(t => t.status === 'fail').length;
      const total = testResults.length;
      const passRate = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;

      let html = `
        <div class="summary">
          <h2 style="color: white; border: none; margin-bottom: 15px;">ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»</h2>
          <div class="stats">
            <div class="stat-card">
              <div class="stat-value">${total}</div>
              <div class="stat-label">æ€»æµ‹è¯•æ•°</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" style="color: #4ec9b0;">${passed}</div>
              <div class="stat-label">é€šè¿‡</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" style="color: #f48771;">${failed}</div>
              <div class="stat-label">å¤±è´¥</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${passRate}%</div>
              <div class="stat-label">é€šè¿‡ç‡</div>
            </div>
          </div>
        </div>
      `;

      const suites = [...new Set(testResults.map(t => t.suite))];
      suites.forEach(suite => {
        const suiteTests = testResults.filter(t => t.suite === suite);
        const suitePassed = suiteTests.filter(t => t.status === 'pass').length;

        html += `
          <div class="test-suite">
            <h3>${suite} (${suitePassed}/${suiteTests.length})</h3>
        `;

        suiteTests.forEach(test => {
          html += `
            <div class="test-case ${test.status}">
              <div class="test-title">
                <span class="status ${test.status}">${test.status === 'pass' ? 'âœ“ PASS' : 'âœ— FAIL'}</span>
                <span>${test.name}</span>
                <span style="margin-left: auto; color: #858585;">${test.duration}ms</span>
              </div>
              ${test.error ? `<div class="test-details error">é”™è¯¯: ${test.error}</div>` : ''}
            </div>
          `;
        });

        html += `</div>`;
      });

      resultsDiv.innerHTML = html;
    }

    function exportResults() {
      const blob = new Blob([JSON.stringify(testResults, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `familiar-test-results-${Date.now()}.json`;
      a.click();
      log('æµ‹è¯•ç»“æœå·²å¯¼å‡º', 'success');
    }

    // ==================== åŠ è½½ familiar-local.ts ä»£ç  ====================
    // ç”±äºæµè§ˆå™¨ç¯å¢ƒé™åˆ¶ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å¤åˆ¶å…³é”®å‡½æ•°
    // å®é™…é¡¹ç›®ä¸­åº”è¯¥æ„å»ºä¸ºJSæ¨¡å—åå¯¼å…¥

    ${`
      // è¿™é‡Œæ’å…¥ familiar-local.ts çš„ç¼–è¯‘åä»£ç 
      // ä¸ºäº†æµ‹è¯•ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å®ç°å…³é”®å‡½æ•°çš„ç®€åŒ–ç‰ˆæœ¬

      const VERSION = 1;
      const storage = mockStorage;

      function get(k) {
        return uni.getStorageSync(k);
      }

      function set(k, v) {
        uni.setStorageSync(k, v);
      }

      function remove(k) {
        uni.removeStorageSync(k);
      }

      function randInt(min, max) {
        if (min >= max) return min;
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      function getCountdownTimeMs(ms) {
        return ms; // ç®€åŒ–ç‰ˆæœ¬
      }

      function getCountdownDays(days) {
        return days;
      }

      // åˆå§‹åŒ–é»˜è®¤é…ç½®
      function initDefaults() {
        const ver = get("fm:stateVersion");
        if (!ver) set("fm:stateVersion", VERSION);

        if (!get("fm:settings")) {
          const settings = {
            cd: {
              bigRoundMinMs: 24 * 60 * 60 * 1000,
              stageMinDays: { "1-2": 3, "2-3": 0, "3-4": 3 },
              zDurationByStage: {
                0: { minMs: 0, maxMs: 0 },
                1: { minMs: 2 * 60 * 1000, maxMs: 4 * 60 * 1000 },
                2: { minMs: 3 * 60 * 1000, maxMs: 6 * 60 * 1000 },
                3: { minMs: 3 * 60 * 1000, maxMs: 7 * 60 * 1000 },
                4: { minMs: 0, maxMs: 0 },
              },
              smallCopyCdMs: 2000,
              idleWarnMs: 40 * 60 * 1000,
              idleForceCdMs: 2 * 60 * 60 * 1000,
              opponentFindWaitMs: 60 * 60 * 1000,
              opponentFindCopyEnableMs: 10 * 60 * 1000,
            },
            vip: { levels: [{ level: 0, qaMaxItems: 2 }, { level: 1, qaMaxItems: 3 }, { level: 2, qaMaxItems: 4 }] },
            stageThresholdX: { 0: 10, 1: 2, 2: 3, 3: 3, 4: 0 },
          };
          set("fm:settings", settings);
        }

        if (!get("fm:libs")) {
          const mkText = (id, text, splitBy) => ({ id, text, type: "text", splitBy });
          const mkZ = (id, text) => ({ id, text, type: "Z" });
          const mkD = (id, text) => ({ id, text, type: "D" });

          const libs = {
            questionnaire: {
              thresholdX: 10,
              questions: [
                { id: "q1", title: "é—®é¢˜1", options: [{ id: "A", text: "é€‰é¡¹A", score: 0 }] },
                { id: "q2", title: "é—®é¢˜2", options: [{ id: "A", text: "é€‰é¡¹A", score: 4 }] },
                { id: "q3", title: "é—®é¢˜3", options: [{ id: "A", text: "é€‰é¡¹A", score: 6 }] },
                { id: "q4", title: "é—®é¢˜4", options: [{ id: "A", text: "é€‰é¡¹A", score: 0 }] },
                { id: "q5", title: "é—®é¢˜5", options: [{ id: "A", text: "é€‰é¡¹A", score: 0 }] },
              ],
            },
            content: {
              S1: [[mkText("c1-1", "å†…å®¹1", "@"), mkZ("c1-2", "Z1"), mkText("c1-3", "å†…å®¹2", "@")]],
              S2: [[mkText("c2-1", "å†…å®¹2", "@")]],
              S3: [[mkText("c3-1", "å†…å®¹3", "@")]],
              S4: [[mkText("c4-1", "å†…å®¹4", "@")]],
              S5: [[mkText("c5-1", "å†…å®¹5", "@")]],
              "S4.5": [[mkText("c4.5-1", "å†…å®¹4.5", "@")]],
            },
            leaving: {
              S1: [[mkText("l1-1", "ç¦»å¼€1", "@")]],
              S2: [[mkText("l2-1", "ç¦»å¼€2", "@")]],
              S3: [[mkText("l3-1", "ç¦»å¼€3", "@")]],
            },
            opponent: {
              S2: [[mkText("op2-1", "å¯¹æ–¹æ‰¾2", "@")]],
            },
            opening: {},
            qa: {},
          };
          set("fm:libs", libs);
        }

        if (!get("fm:tasks")) set("fm:tasks", []);
      }

      function genId() {
        return "fm_" + Date.now() + "_" + Math.floor(Math.random() * 10000);
      }

      // åˆ›å»ºä»»åŠ¡
      function createTask(payload) {
        initDefaults();
        const { name, durationDays } = payload;
        if (!name || name.trim().length === 0 || name.trim().length > 6) {
          return { ok: false, reason: "åç§°éœ€1-6å­—" };
        }
        const id = genId();
        const now = Date.now();
        const expireAt = now + durationDays * 24 * 60 * 60 * 1000;
        const settings = get("fm:settings");
        const vipMax = settings.vip.levels[0].qaMaxItems;

        const task = {
          id,
          name: name.trim(),
          createdAt: now,
          durationDays,
          expireAt,
          isRestartHalfPrice: false,
          status: "active",
          stageIndex: 0,
          roundIndex: null,
          stepIndex: 0,
          stageScore: 0,
          totalScore: 0,
          stageThresholdX: settings.stageThresholdX[0],
          roundCdUnlockAt: null,
          stageCdUnlockAt: null,
          zUnlockAt: null,
          dMode: false,
          opponentFindUnlockAt: null,
          opponentFindCopyUnlockAt: null,
          idleWarningAt: null,
          hardIdleToCdAt: null,
          lastActionAt: now,
          usedLibIdsByStage: {},
          currentLibChain: null,
          opponentFindUsedInRound: false,
          qaVipMaxItems: vipMax,
          questionnaire: { answers: [], totalScore: 0, routedModule: "familiar" },
          prompts: {},
          askFlow: {},
          renewHistory: [],
          listBadge: "èŠå¤©ä»»åŠ¡è¿›è¡Œä¸­",
          listCountdownEndAt: null,
        };

        const ids = get("fm:tasks") || [];
        ids.push(id);
        set("fm:tasks", ids);
        set(\`fm:task:\${id}\`, task);
        return { ok: true, task };
      }

      function getTask(taskId) {
        initDefaults();
        const t = get(\`fm:task:\${taskId}\`);
        return t || null;
      }

      // é—®å·ç›¸å…³
      function saveQuestionnaireAnswer(taskId, questionId, optionId) {
        initDefaults();
        const t = getTask(taskId);
        if (!t) return;
        const libs = get("fm:libs");
        const q = libs.questionnaire.questions.find((x) => x.id === questionId);
        if (!q) return;
        const opt = q.options.find((o) => o.id === optionId);
        const score = opt ? opt.score : 0;

        const idx = t.questionnaire.answers.findIndex((a) => a.questionId === questionId);
        if (idx >= 0) t.questionnaire.answers[idx] = { questionId, optionId, score };
        else t.questionnaire.answers.push({ questionId, optionId, score });

        t.questionnaire.totalScore = t.questionnaire.answers.reduce((sum, a) => sum + a.score, 0);
        t.lastActionAt = Date.now();
        set(\`fm:task:\${taskId}\`, t);
      }

      function submitQuestionnaire(taskId) {
        initDefaults();
        const t = getTask(taskId);
        if (!t) return { routed: "familiar", next: "é—®1" };
        const libs = get("fm:libs");
        const X = libs.questionnaire.thresholdX;
        const score = t.questionnaire.totalScore;

        let routed = "familiar";
        if (score < X) {
          routed = "familiar";
        }

        t.stageIndex = 0;
        t.stepIndex = 0;
        t.lastActionAt = Date.now();
        set(\`fm:task:\${taskId}\`, t);

        return { routed, next: "é—®1" };
      }

      // ç¬¬ä¸€é˜¶æ®µ
      function enterStage1(taskId) {
        initDefaults();
        const t = getTask(taskId);
        if (!t) return { ok: false, reason: "ä»»åŠ¡ä¸å­˜åœ¨" };

        t.stageIndex = 1;
        t.roundIndex = 0;
        t.stepIndex = 0;
        t.stageScore = 0;
        t.stageThresholdX = 2;
        t.status = "active";

        t.stage1 = {
          roundScores: [],
          firstThreeRoundsTotal: 0,
          currentRoundStartTime: null,
          roundAllowedTimeMs: 30 * 60 * 1000,
          zTimerMs: randInt(2 * 60 * 1000, 4 * 60 * 1000),
          hasUsedOpponentFind: false,
          roundCdMultiplier: 1,
        };

        t.stageCdUnlockAt = null;
        t.listCountdownEndAt = null;
        t.listBadge = "èŠå¤©ä»»åŠ¡è¿›è¡Œä¸­";

        set(\`fm:task:\${taskId}\`, t);
        return { ok: true, task: t };
      }

      function finishStage1Round(taskId, roundScore) {
        initDefaults();
        const t = getTask(taskId);
        if (!t || !t.stage1) return { ok: false, reason: "ä»»åŠ¡ä¸åœ¨ç¬¬ä¸€é˜¶æ®µ" };

        const roundNumber = t.roundIndex || 0;

        t.stage1.roundScores[roundNumber - 1] = roundScore;
        t.stageScore += roundScore;
        t.totalScore += roundScore;

        if (roundNumber <= 3) {
          t.stage1.firstThreeRoundsTotal = t.stage1.roundScores.slice(0, 3).reduce((sum, score) => sum + score, 0);
        }

        set(\`fm:task:\${taskId}\`, t);
        return { ok: true, task: t };
      }

      function checkStage1RoundTransition(taskId) {
        initDefaults();
        const t = getTask(taskId);
        if (!t || !t.stage1) return { ok: false, reason: "ä»»åŠ¡ä¸åœ¨ç¬¬ä¸€é˜¶æ®µ" };

        const roundNumber = t.roundIndex || 0;
        const stageScore = t.stageScore;
        const firstThreeRoundsTotal = t.stage1.firstThreeRoundsTotal;

        if (roundNumber === 3) {
          if (stageScore >= t.stageThresholdX) {
            return { ok: true, action: "enterRound4", reason: "å‰ä¸‰å›åˆå¾—åˆ†è¶³å¤Ÿ" };
          }
          return { ok: true, action: "enterRound5", reason: "å‰ä¸‰å›åˆå¾—åˆ†ä¸è¶³ï¼Œè¿›å…¥å»¶æ—¶å›åˆ" };
        } else if (roundNumber === 4) {
          return {
            ok: true,
            action: "enterStageCd",
            reason: "ç¬¬å››å›åˆå®Œæˆï¼Œè¿›å…¥é˜¶æ®µCD",
            stageCdRange: { minDays: 3, maxDays: 5 }
          };
        } else if (roundNumber === 5) {
          if (stageScore === firstThreeRoundsTotal) {
            return { ok: true, action: "enterRound6", reason: "å¾—åˆ†ç›¸ç­‰ï¼Œè¿›å…¥ç¬¬å…­å›åˆ" };
          }
          return { ok: true, action: "enterStageCd", reason: "å¾—åˆ†ä¸ç­‰ï¼Œè¿›å…¥é˜¶æ®µCD" };
        } else if (roundNumber === 6) {
          if (stageScore === firstThreeRoundsTotal) {
            return { ok: true, action: "showPromptS7", reason: "å¾—åˆ†ç›¸ç­‰ï¼Œè¯¢é—®æ˜¯å¦åšæŒ" };
          }
          return { ok: true, action: "enterStageCd", reason: "å¾—åˆ†ä¸ç­‰ï¼Œè¿›å…¥é˜¶æ®µCD" };
        }

        return { ok: true, action: "continue", reason: "ç»§ç»­å½“å‰å›åˆ" };
      }

      // æ·»åŠ ç§¯åˆ†
      function addPoint(taskId, amount, source = "other") {
        initDefaults();
        const t = getTask(taskId);
        if (!t) return;
        t.stageScore += amount;
        t.totalScore += amount;
        t.lastActionAt = Date.now();
        set(\`fm:task:\${taskId}\`, t);
      }

      // å¯¼å‡ºä¾›æµ‹è¯•ä½¿ç”¨
      window.FamiliarModule = {
        initDefaults,
        createTask,
        getTask,
        saveQuestionnaireAnswer,
        submitQuestionnaire,
        enterStage1,
        finishStage1Round,
        checkStage1RoundTransition,
        addPoint,
      };
    `}
  </script>

  <script>
    // ==================== æµ‹è¯•ç”¨ä¾‹ ====================

    function runAllTests() {
      clearResults();
      log('å¼€å§‹æ‰§è¡Œæ‰€æœ‰æµ‹è¯•...', 'warning');

      testBasicFunctions();
      testQuestionnaireFlow();
      testStage1Flow();
      testScoringLogic();
      testEdgeCases();

      log('\næ‰€æœ‰æµ‹è¯•å®Œæˆ!', 'success');
      renderResults();
    }

    function runQuickTests() {
      clearResults();
      log('æ‰§è¡Œå¿«é€Ÿæµ‹è¯•...', 'warning');

      testBasicFunctions();
      testQuestionnaireFlow();

      log('\nå¿«é€Ÿæµ‹è¯•å®Œæˆ!', 'success');
      renderResults();
    }

    // æµ‹è¯•å¥—ä»¶1: åŸºæœ¬åŠŸèƒ½
    function testBasicFunctions() {
      testSuite('åŸºæœ¬åŠŸèƒ½æµ‹è¯•', () => {
        testCase('åˆå§‹åŒ–é»˜è®¤é…ç½®', () => {
          FamiliarModule.initDefaults();
          const settings = uni.getStorageSync('fm:settings');
          assert(settings !== null, 'è®¾ç½®åº”è¯¥è¢«åˆå§‹åŒ–');
          assert(settings.stageThresholdX[1] === 2, 'ç¬¬ä¸€é˜¶æ®µé˜ˆå€¼åº”ä¸º2');
        });

        testCase('åˆ›å»ºä»»åŠ¡ - æ­£å¸¸æƒ…å†µ', () => {
          const result = FamiliarModule.createTask({ name: 'æµ‹è¯•ä»»åŠ¡', durationDays: 5 });
          assert(result.ok === true, 'åº”è¯¥åˆ›å»ºæˆåŠŸ');
          assert(result.task.name === 'æµ‹è¯•ä»»åŠ¡', 'ä»»åŠ¡åç§°åº”æ­£ç¡®');
          assert(result.task.durationDays === 5, 'ä»»åŠ¡å¤©æ•°åº”æ­£ç¡®');
          assert(result.task.stageIndex === 0, 'åˆå§‹é˜¶æ®µåº”ä¸º0');
        });

        testCase('åˆ›å»ºä»»åŠ¡ - åç§°éªŒè¯', () => {
          const result1 = FamiliarModule.createTask({ name: '', durationDays: 5 });
          assert(result1.ok === false, 'ç©ºåç§°åº”è¯¥å¤±è´¥');

          const result2 = FamiliarModule.createTask({ name: 'è¶…è¿‡å…­ä¸ªå­—çš„åç§°', durationDays: 5 });
          assert(result2.ok === false, 'è¶…é•¿åç§°åº”è¯¥å¤±è´¥');

          const result3 = FamiliarModule.createTask({ name: 'æ­£å¸¸', durationDays: 5 });
          assert(result3.ok === true, 'æ­£å¸¸åç§°åº”è¯¥æˆåŠŸ');
        });

        testCase('è·å–ä»»åŠ¡', () => {
          const createResult = FamiliarModule.createTask({ name: 'ä»»åŠ¡1', durationDays: 5 });
          const taskId = createResult.task.id;

          const task = FamiliarModule.getTask(taskId);
          assert(task !== null, 'åº”è¯¥èƒ½è·å–ä»»åŠ¡');
          assertEqual(task.name, 'ä»»åŠ¡1', 'ä»»åŠ¡åç§°åº”åŒ¹é…');
        });
      });
    }

    // æµ‹è¯•å¥—ä»¶2: é—®å·æµç¨‹
    function testQuestionnaireFlow() {
      testSuite('é—®å·æµç¨‹æµ‹è¯•', () => {
        let taskId;

        testCase('é—®å·åˆå§‹åŒ–', () => {
          const result = FamiliarModule.createTask({ name: 'é—®å·æµ‹è¯•', durationDays: 5 });
          taskId = result.task.id;

          const task = FamiliarModule.getTask(taskId);
          assertEqual(task.questionnaire.totalScore, 0, 'åˆå§‹åˆ†æ•°åº”ä¸º0');
          assertEqual(task.questionnaire.answers.length, 0, 'åˆå§‹ç­”æ¡ˆåº”ä¸ºç©º');
        });

        testCase('ä¿å­˜é—®å·ç­”æ¡ˆ', () => {
          FamiliarModule.saveQuestionnaireAnswer(taskId, 'q1', 'A');
          const task = FamiliarModule.getTask(taskId);
          assertEqual(task.questionnaire.answers.length, 1, 'åº”è¯¥æœ‰1ä¸ªç­”æ¡ˆ');
        });

        testCase('é—®å·è®¡åˆ†', () => {
          FamiliarModule.saveQuestionnaireAnswer(taskId, 'q2', 'A'); // 4åˆ†
          FamiliarModule.saveQuestionnaireAnswer(taskId, 'q3', 'A'); // 6åˆ†

          const task = FamiliarModule.getTask(taskId);
          assertEqual(task.questionnaire.totalScore, 10, 'æ€»åˆ†åº”ä¸º10åˆ†');
        });

        testCase('é—®å·æäº¤ - å¾—åˆ†â‰¥é˜ˆå€¼', () => {
          const result = FamiliarModule.submitQuestionnaire(taskId);
          assertEqual(result.routed, 'familiar', 'åº”è¯¥è·¯ç”±åˆ°ç†Ÿæ‚‰æ¨¡å—');
          assertEqual(result.next, 'é—®1', 'ä¸‹ä¸€æ­¥åº”ä¸ºé—®1');
        });

        testCase('é—®å·æäº¤ - å¾—åˆ†<é˜ˆå€¼', () => {
          const result2 = FamiliarModule.createTask({ name: 'ä½åˆ†ä»»åŠ¡', durationDays: 5 });
          const lowScoreTaskId = result2.task.id;

          FamiliarModule.saveQuestionnaireAnswer(lowScoreTaskId, 'q1', 'A'); // 0åˆ†
          FamiliarModule.saveQuestionnaireAnswer(lowScoreTaskId, 'q2', 'A'); // 4åˆ†
          // æ€»åˆ†4åˆ† < 10åˆ†

          const submitResult = FamiliarModule.submitQuestionnaire(lowScoreTaskId);
          const task = FamiliarModule.getTask(lowScoreTaskId);
          assert(task.questionnaire.totalScore < 10, 'å¾—åˆ†åº”å°äºé˜ˆå€¼');
        });
      });
    }

    // æµ‹è¯•å¥—ä»¶3: ç¬¬ä¸€é˜¶æ®µæµç¨‹
    function testStage1Flow() {
      testSuite('ç¬¬ä¸€é˜¶æ®µæµç¨‹æµ‹è¯•', () => {
        let taskId;

        testCase('è¿›å…¥ç¬¬ä¸€é˜¶æ®µ', () => {
          const createResult = FamiliarModule.createTask({ name: 'é˜¶æ®µ1æµ‹è¯•', durationDays: 5 });
          taskId = createResult.task.id;

          const result = FamiliarModule.enterStage1(taskId);
          assert(result.ok === true, 'åº”è¯¥æˆåŠŸè¿›å…¥');

          const task = FamiliarModule.getTask(taskId);
          assertEqual(task.stageIndex, 1, 'é˜¶æ®µåº”ä¸º1');
          assertEqual(task.stageThresholdX, 2, 'é˜ˆå€¼åº”ä¸º2');
          assert(task.stage1 !== undefined, 'stage1æ•°æ®åº”å­˜åœ¨');
        });

        testCase('ç¬¬ä¸€é˜¶æ®µæ•°æ®ç»“æ„', () => {
          const task = FamiliarModule.getTask(taskId);
          assert(Array.isArray(task.stage1.roundScores), 'roundScoresåº”ä¸ºæ•°ç»„');
          assertEqual(task.stage1.firstThreeRoundsTotal, 0, 'å‰ä¸‰å›åˆæ€»åˆ†åˆå§‹ä¸º0');
          assertEqual(task.stage1.roundCdMultiplier, 1, 'CDå€æ•°åˆå§‹ä¸º1');
        });

        testCase('å®Œæˆå›åˆå¹¶è®°å½•å¾—åˆ†', () => {
          const task = FamiliarModule.getTask(taskId);
          task.roundIndex = 1;
          uni.setStorageSync(\`fm:task:\${taskId}\`, task);

          FamiliarModule.finishStage1Round(taskId, 1); // å›åˆ1å¾—1åˆ†

          const updatedTask = FamiliarModule.getTask(taskId);
          assertEqual(updatedTask.stageScore, 1, 'é˜¶æ®µå¾—åˆ†åº”ä¸º1');
          assertEqual(updatedTask.stage1.roundScores[0], 1, 'å›åˆ1å¾—åˆ†åº”è®°å½•ä¸º1');
        });

        testCase('ç§¯åˆ†ç´¯åŠ ', () => {
          FamiliarModule.addPoint(taskId, 1, 'leaving');
          const task = FamiliarModule.getTask(taskId);
          assertEqual(task.stageScore, 2, 'é˜¶æ®µå¾—åˆ†åº”ç´¯åŠ åˆ°2');
          assertEqual(task.totalScore, 2, 'æ€»å¾—åˆ†åº”ä¸º2');
        });
      });
    }

    // æµ‹è¯•å¥—ä»¶4: åˆ¤åˆ†é€»è¾‘
    function testScoringLogic() {
      testSuite('åˆ¤åˆ†é€»è¾‘æµ‹è¯•', () => {
        testCase('ç¬¬3å›åˆååˆ¤åˆ† - å¾—åˆ†è¶³å¤Ÿ', () => {
          const result = FamiliarModule.createTask({ name: 'åˆ¤åˆ†æµ‹è¯•1', durationDays: 5 });
          const taskId = result.task.id;

          FamiliarModule.enterStage1(taskId);

          const task = FamiliarModule.getTask(taskId);
          task.roundIndex = 3;
          task.stageScore = 2; // è¾¾åˆ°é˜ˆå€¼
          uni.setStorageSync(\`fm:task:\${taskId}\`, task);

          const transition = FamiliarModule.checkStage1RoundTransition(taskId);
          assertEqual(transition.action, 'enterRound4', 'åº”è¯¥è¿›å…¥ç¬¬4å›åˆ');
        });

        testCase('ç¬¬3å›åˆååˆ¤åˆ† - å¾—åˆ†ä¸è¶³', () => {
          const result = FamiliarModule.createTask({ name: 'åˆ¤åˆ†æµ‹è¯•2', durationDays: 5 });
          const taskId = result.task.id;

          FamiliarModule.enterStage1(taskId);

          const task = FamiliarModule.getTask(taskId);
          task.roundIndex = 3;
          task.stageScore = 1; // å°äºé˜ˆå€¼2
          uni.setStorageSync(\`fm:task:\${taskId}\`, task);

          const transition = FamiliarModule.checkStage1RoundTransition(taskId);
          assertEqual(transition.action, 'enterRound5', 'åº”è¯¥è¿›å…¥ç¬¬5å›åˆ');
        });

        testCase('ç¬¬4å›åˆå - è¿›å…¥é˜¶æ®µCD', () => {
          const result = FamiliarModule.createTask({ name: 'åˆ¤åˆ†æµ‹è¯•3', durationDays: 5 });
          const taskId = result.task.id;

          FamiliarModule.enterStage1(taskId);

          const task = FamiliarModule.getTask(taskId);
          task.roundIndex = 4;
          uni.setStorageSync(\`fm:task:\${taskId}\`, task);

          const transition = FamiliarModule.checkStage1RoundTransition(taskId);
          assertEqual(transition.action, 'enterStageCd', 'åº”è¯¥è¿›å…¥é˜¶æ®µCD');
          assert(transition.stageCdRange !== undefined, 'åº”è¯¥è¿”å›CDå¤©æ•°èŒƒå›´');
        });

        testCase('ç¬¬5å›åˆåˆ¤åˆ† - å¾—åˆ†ç›¸ç­‰', () => {
          const result = FamiliarModule.createTask({ name: 'åˆ¤åˆ†æµ‹è¯•4', durationDays: 5 });
          const taskId = result.task.id;

          FamiliarModule.enterStage1(taskId);

          const task = FamiliarModule.getTask(taskId);
          task.roundIndex = 5;
          task.stageScore = 2;
          task.stage1.firstThreeRoundsTotal = 2;
          uni.setStorageSync(\`fm:task:\${taskId}\`, task);

          const transition = FamiliarModule.checkStage1RoundTransition(taskId);
          assertEqual(transition.action, 'enterRound6', 'å¾—åˆ†ç›¸ç­‰åº”è¿›å…¥ç¬¬6å›åˆ');
        });

        testCase('ç¬¬5å›åˆåˆ¤åˆ† - å¾—åˆ†ä¸ç­‰', () => {
          const result = FamiliarModule.createTask({ name: 'åˆ¤åˆ†æµ‹è¯•5', durationDays: 5 });
          const taskId = result.task.id;

          FamiliarModule.enterStage1(taskId);

          const task = FamiliarModule.getTask(taskId);
          task.roundIndex = 5;
          task.stageScore = 3;
          task.stage1.firstThreeRoundsTotal = 2;
          uni.setStorageSync(\`fm:task:\${taskId}\`, task);

          const transition = FamiliarModule.checkStage1RoundTransition(taskId);
          assertEqual(transition.action, 'enterStageCd', 'å¾—åˆ†ä¸ç­‰åº”è¿›å…¥é˜¶æ®µCD');
        });

        testCase('ç¬¬6å›åˆåˆ¤åˆ† - å¾—åˆ†ç›¸ç­‰', () => {
          const result = FamiliarModule.createTask({ name: 'åˆ¤åˆ†æµ‹è¯•6', durationDays: 5 });
          const taskId = result.task.id;

          FamiliarModule.enterStage1(taskId);

          const task = FamiliarModule.getTask(taskId);
          task.roundIndex = 6;
          task.stageScore = 2;
          task.stage1.firstThreeRoundsTotal = 2;
          uni.setStorageSync(\`fm:task:\${taskId}\`, task);

          const transition = FamiliarModule.checkStage1RoundTransition(taskId);
          assertEqual(transition.action, 'showPromptS7', 'åº”è¯¥æ˜¾ç¤ºæç¤ºæ¿S7');
        });
      });
    }

    // æµ‹è¯•å¥—ä»¶5: è¾¹ç•Œæƒ…å†µ
    function testEdgeCases() {
      testSuite('è¾¹ç•Œæƒ…å†µæµ‹è¯•', () => {
        testCase('è·å–ä¸å­˜åœ¨çš„ä»»åŠ¡', () => {
          const task = FamiliarModule.getTask('non-existent-id');
          assert(task === null, 'ä¸å­˜åœ¨çš„ä»»åŠ¡åº”è¿”å›null');
        });

        testCase('é‡å¤ä¿å­˜åŒä¸€é—®å·ç­”æ¡ˆ', () => {
          const result = FamiliarModule.createTask({ name: 'é‡å¤ç­”æ¡ˆ', durationDays: 5 });
          const taskId = result.task.id;

          FamiliarModule.saveQuestionnaireAnswer(taskId, 'q1', 'A');
          FamiliarModule.saveQuestionnaireAnswer(taskId, 'q1', 'A');

          const task = FamiliarModule.getTask(taskId);
          assertEqual(task.questionnaire.answers.length, 1, 'é‡å¤ç­”æ¡ˆåº”è¯¥åªè®°å½•ä¸€æ¬¡');
        });

        testCase('é˜¶æ®µè½¬æ¢æ—¶çš„æ•°æ®ä¸€è‡´æ€§', () => {
          const result = FamiliarModule.createTask({ name: 'æ•°æ®ä¸€è‡´æ€§', durationDays: 5 });
          const taskId = result.task.id;

          const initialTask = FamiliarModule.getTask(taskId);
          const initialTotalScore = initialTask.totalScore;

          FamiliarModule.enterStage1(taskId);

          const task = FamiliarModule.getTask(taskId);
          assertEqual(task.totalScore, initialTotalScore, 'è¿›å…¥æ–°é˜¶æ®µä¸åº”å½±å“æ€»å¾—åˆ†');
          assertEqual(task.stageScore, 0, 'é˜¶æ®µå¾—åˆ†åº”é‡ç½®ä¸º0');
        });

        testCase('ç©ºåç§°ä»»åŠ¡åˆ›å»º', () => {
          const result = FamiliarModule.createTask({ name: '   ', durationDays: 5 });
          assert(result.ok === false, 'ç©ºç™½åç§°åº”è¯¥åˆ›å»ºå¤±è´¥');
        });

        testCase('å‰ä¸‰å›åˆæ€»åˆ†è®¡ç®—', () => {
          const result = FamiliarModule.createTask({ name: 'æ€»åˆ†è®¡ç®—', durationDays: 5 });
          const taskId = result.task.id;

          FamiliarModule.enterStage1(taskId);

          let task = FamiliarModule.getTask(taskId);
          task.roundIndex = 1;
          uni.setStorageSync(\`fm:task:\${taskId}\`, task);
          FamiliarModule.finishStage1Round(taskId, 1);

          task = FamiliarModule.getTask(taskId);
          task.roundIndex = 2;
          uni.setStorageSync(\`fm:task:\${taskId}\`, task);
          FamiliarModule.finishStage1Round(taskId, 0);

          task = FamiliarModule.getTask(taskId);
          task.roundIndex = 3;
          uni.setStorageSync(\`fm:task:\${taskId}\`, task);
          FamiliarModule.finishStage1Round(taskId, 1);

          task = FamiliarModule.getTask(taskId);
          assertEqual(task.stage1.firstThreeRoundsTotal, 2, 'å‰ä¸‰å›åˆæ€»åˆ†åº”ä¸º2');
          assertEqual(task.stageScore, 2, 'é˜¶æ®µå¾—åˆ†åº”ä¸º2');
        });
      });
    }

    // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºè¯´æ˜
    window.onload = function() {
      log('=== ç†Ÿæ‚‰æ¨¡å—åŠŸèƒ½æµ‹è¯•ç³»ç»Ÿ ===', 'success');
      log('');
      log('ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•:', 'warning');
      log('â€¢ è¿è¡Œæ‰€æœ‰æµ‹è¯•: æ‰§è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶');
      log('â€¢ å¿«é€Ÿæµ‹è¯•: ä»…æµ‹è¯•åŸºæœ¬åŠŸèƒ½å’Œé—®å·');
      log('â€¢ æ¸…é™¤ç»“æœ: é‡ç½®æµ‹è¯•ç¯å¢ƒ');
      log('â€¢ å¯¼å‡ºæŠ¥å‘Š: ä¸‹è½½JSONæ ¼å¼æµ‹è¯•ç»“æœ');
      log('');
      log('æµ‹è¯•è¦†ç›–èŒƒå›´:', 'warning');
      log('âœ“ åŸºæœ¬åŠŸèƒ½ (åˆå§‹åŒ–ã€åˆ›å»ºä»»åŠ¡ã€è·å–ä»»åŠ¡)');
      log('âœ“ é—®å·æµç¨‹ (ä¿å­˜ç­”æ¡ˆã€è®¡åˆ†ã€æäº¤)');
      log('âœ“ ç¬¬ä¸€é˜¶æ®µ (è¿›å…¥é˜¶æ®µã€å›åˆç®¡ç†ã€ç§¯åˆ†)');
      log('âœ“ åˆ¤åˆ†é€»è¾‘ (æ‰€æœ‰å›åˆè½¬æ¢åˆ†æ”¯)');
      log('âœ“ è¾¹ç•Œæƒ…å†µ (æ•°æ®ä¸€è‡´æ€§ã€å¼‚å¸¸è¾“å…¥)');
      log('');
      log('å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…æµ‹è¯•æŒ‡ä»¤...', 'success');
    };
  </script>
</body>
</html>
